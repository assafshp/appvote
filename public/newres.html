<!DOCTYPE html>
<html dir="rtl" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Labs 2021</title>
    <!-- <link rel="preconnect" href="https://fonts.gstatic.com"> -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"> -->
    <link rel="stylesheet" href="css/res.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/media-queries.css" />
</head>

<body>
    <div id="film-container">
        <div class="animated-flicker">
            <svg id="film-mask" version="1.1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="100%" height="100%"
                preserveAspectRatio="none" viewBox="0 0 400 225">
                <rect class="rectangle01" width="400" height="225" />
                <line id="line-h" class="line01" x1="0" y1="112.5" x2="400" y2="112.5" />
                <line id="line-v" class="line02" x1="200" y1="0" x2="200" y2="225" />
            </svg>
            <svg id="film-countdown" version="1.1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="100%" height="100%"
                viewBox="0 0 400 225">
                <circle id="circle-outer" class="circle01" cx="200" cy="112.5" r="95" />
                <circle id="circle-inner" class="circle01" cx="200" cy="112.5" r="85" />
                <circle class="circle02 animated-rotate" cx="200" cy="112.5" r="494.5" />
                <g id="numbers" text-anchor="middle" class="no-select">
                    <text id="animated-text1" x="200.5" y="155">10</text>
                    <text id="animated-text2" x="200.5" y="155">9</text>
                    <text id="animated-text3" x="200.5" y="155">8</text>
                    <text id="animated-text4" x="200.5" y="155">7</text>
                    <text id="animated-text5" x="200.5" y="155">6</text>
                    <text id="animated-text6" x="200.5" y="155">5</text>
                    <text id="animated-text7" x="200.5" y="155">4</text>
                    <text id="animated-text8" x="200.5" y="155">3</text>
                    <text id="animated-text9" x="200.5" y="155">2</text>
                    <text id="animated-text10" x="200.5" y="155">1</text>
                </g>
            </svg>
        </div>
    </div>

    <div id="message-container">


    </div>
    <!-- APP -->
    <div id="app">
        <div class="app-overlay"></div>
        <!-- HEADER -->
        <header>
            <!-- <a href="#topAnchor"></a>  -->

            <div id="xlogo" class="logo logo-res">
                <img src="images/xlabs_icon.png">
            </div>
        </header>
        <!-- MAIN -->
        <main>

            <h1 id="main" class="main-title">והתוצאות</h1>
            <h5 id="main1" class="main-title2">המיזמים הצליחו לגייס:</h5>
            <div id="cards" class="cards-res" style="opacity: 1;">
                <div class="card-res" id="0">
                    <div class="card-info-res">
                        <div class="candidate-info">
                            <h1>מיזם</h1>
                        </div>
                        <div class="candidate-info">
                            <img src="images/trophy.png" class="app-logo undefined" style="width: 4rem;">
                        </div>
                        <div class="candidate-info">
                            <img src="images/dollar.png" class="app-logo dollar undefined">
                        </div>
                        <div class="candidate-info">
                            <img src="images/people.png" class="app-logo undefined">

                        </div>
                    </div>
                    <div class="card-info-res">
                        <div class="candidate-info">
                            <img src="images/miba.png" class="app-logo-res undefined">
                        </div>
                        <div class="candidate-info">
                            <img id="mibawin" src="images/winner.png" style="display:none;width: 4rem;">
                        </div>
                        <div class="candidate-info">
                            <h1 id="mibacount" class=""></h1>
                        </div>
                        <div class="candidate-info">
                            <h1 id="mibaamount" class=""></h1>
                        </div>
                    </div>
                    <div class="card-info-res">
                        <div class="candidate-info">
                            <img src="images/yarok.png" class="app-logo-res undefined">
                        </div>
                        <div class="candidate-info">
                            <img id="yarockwin" src="images/winner.png" style="display:none;width: 4rem;">
                        </div>
                        <div class="candidate-info">
                            <h1 id="yarockcount" class=""></h1>
                        </div>
                        <div class="candidate-info">
                            <h1 id="yarockamount" class=""></h1>
                        </div>
                    </div>
                    <div class="card-info-res">
                        <div class="candidate-info">
                            <img src="images/beenthere.png" class="app-logo-res beenthere-res">
                        </div>
                        <div class="candidate-info">
                            <img id="beentherewin" src="images/winner.png" style="display:none;width: 4rem;">
                        </div>
                        <div class="candidate-info">
                            <h1 id="beentherecount" class=""></h1>
                        </div>
                        <div class="candidate-info">
                            <h1 id="beenthereamount" class=""></h1>
                        </div>
                    </div>
                </div>




            </div>
            <div id="endvote" class="main-title endvote" style="display: none;">
                <h4 class="end-text">מעולה, תודה רבה ! </h4>
                <div>
                    <img class="xlabs-logo" src="images/xlabs_icon.png">
                </div>
            </div>
        </main>
    </div>
</body>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
<script>
    (function () {
        if (!window.requestAnimationFrame) {
            var nLastTime = 0,
                aVendors = ['moz', 'ms', 'o', 'webkit'];
            for (var i = 0; i < aVendors.length; ++i) {
                window.requestAnimationFrame = window[aVendors[i] + 'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[aVendors[i] + 'CancelAnimationFrame'] || window[aVendors[i] + 'CancelRequestAnimationFrame'];
            }
            window.requestAnimationFrame = function (callback, element) {
                var nCurrentTime = new Date().getTime(),
                    nTimeToCall = Math.max(0, 16 - (nCurrentTime - nLastTime)),
                    nTimer = window.setTimeout(function () {
                        callback(nCurrentTime + nTimeToCall);
                    }, nTimeToCall);
                nLastTime = nCurrentTime + nTimeToCall;
                return nTimer;
            };
        }
        if (!window.cancelAnimationFrame) {
            window.cancelAnimationFrame = function (nTimer) {
                clearTimeout(nTimer);
            };
        }
    }());

    var circleOuter = document.getElementById('circle-outer'),
        circleInner = document.getElementById('circle-inner'),
        lineH = document.getElementById('line-h'),
        lineV = document.getElementById('line-v'),
        numbers = document.getElementById('numbers'),
        nCircleCx = +circleOuter.getAttribute('cx'),
        nCircleCy = +circleOuter.getAttribute('cy'),
        nLineY = +lineH.getAttribute('y1'),
        nLineX = +lineV.getAttribute('x1'),
        nFps = 12, // Just like vintage silent films :]
        nJitterLevel = 2.5, // How shaky is the projector?
        nTick = 0;

    function jitter() {
        setTimeout(function () {
            if (nTick === nFps * 9) {
                // Reset position
                circleOuter.setAttribute('cx', nCircleCx);
                circleInner.setAttribute('cx', nCircleCx);
                circleOuter.setAttribute('cy', nCircleCy);
                circleInner.setAttribute('cy', nCircleCy);
                lineH.setAttribute('y1', nLineY);
                lineH.setAttribute('y2', nLineY);
                lineV.setAttribute('x1', nLineX);
                lineV.setAttribute('x2', nLineX);
                numbers.style.transform = '';
                // Transition after countdown
                document.body.className = 'message';
                return;
            }
            // Use rAF for improved performance
            requestAnimationFrame(jitter);
            // Repaint!
            var nOffsetX = Math.random() * nJitterLevel * ((Math.random() >= 0.5) ? 1 : -1),
                nOffsetY = Math.random() * nJitterLevel * ((Math.random() >= 0.5) ? 1 : -1);
            circleOuter.setAttribute('cx', nCircleCx + nOffsetX);
            circleInner.setAttribute('cx', nCircleCx + nOffsetX);
            circleOuter.setAttribute('cy', nCircleCy + nOffsetY);
            circleInner.setAttribute('cy', nCircleCy + nOffsetY);
            lineH.setAttribute('y1', nLineY + nOffsetY);
            lineH.setAttribute('y2', nLineY + nOffsetY);
            lineV.setAttribute('x1', nLineX + nOffsetX);
            lineV.setAttribute('x2', nLineX + nOffsetX);
            numbers.style.transform = 'translate3d(' + nOffsetX + 'px, ' + nOffsetY + 'px, 0)';
            ++nTick;
            // console.log(nTick);
            if (nTick == 105) {  //105
                document.getElementById('message-container').remove();
                document.getElementById('film-container').remove();

            }
        }, 1000 / nFps);
    }

    jitter();



    let results = {};

    const loadEl = document.querySelector('#main');
    const loadEl1 = document.querySelector('#main1');

    let inviteeName = '';
    let voteCount = 0;

    var firebaseConfig = {
        apiKey: "AIzaSyBGvPBIU_J7NHpUqAYxmJm7XHs8JQDJzbQ",
        authDomain: "xappvote.firebaseapp.com",
        projectId: "xappvote",
        storageBucket: "xappvote.appspot.com",
        messagingSenderId: "582541238903",
        appId: "1:582541238903:web:c6ccd79e010899408ddc72"
    };

    var app;
    var db;

    const urlParams = new URLSearchParams(window.location.search);
    const phone = urlParams.get('p') || true;
    console.log(`phone=${phone}`);
    const type = urlParams.get('t');
    let votes = {};
    let event = {};


    let candidates = [
        {
            id: 0,
            name: "MiBa",
            img: "miba.png"
        },
        {
            id: 1,
            name: "YaRock",
            img: "yarok.png",
            class: "yarok"
        },
        {
            id: 2,
            name: "BeenThere",
            img: "beenthere.png",
            class: "beenthere"
        }

    ]

    function resultsView(results, winnerName) {

        document.getElementById('mibacount').innerText = results.miba.count;
        document.getElementById('mibaamount').innerText = results.miba.amount;

        document.getElementById('yarockcount').innerText = results.yarock.count;
        document.getElementById('yarockamount').innerText = results.yarock.amount;

        document.getElementById('beentherecount').innerText = results.beenthere.count;
        document.getElementById('beenthereamount').innerText = results.beenthere.amount;

        switch (winnerName) {
            case 'miba':
                document.getElementById('mibawin').style.display = '';
                break;
            case 'yarock':
                document.getElementById('yarockwin').style.display = '';
                break;
            case 'beenthere':
                document.getElementById('beentherewin').style.display = '';
                break;
            default:
                break;
        }
    }


    document.addEventListener('DOMContentLoaded', async () => {

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(app);

            // const loadEl = document.querySelector('#main');



            if (phone) {

                let winnerCount = 0;
                let winnerName = '';

                let mibasum = 0;
                let mibacount = 0;
                await db.collection("votes").where("vote", "==", "miba").get().then((qq) => {
                    qq.forEach((doc) => {
                        mibacount++;
                        mibasum = mibasum + doc.data().sum;
                    });
                });
                if (mibasum > winnerCount) {
                    winnerCount = mibasum;
                    winnerName = 'miba';
                };
                let yarocksum = 0;
                let yarockcount = 0;
                await db.collection("votes").where("vote", "==", "yarock").get().then((qq) => {
                    qq.forEach((doc) => {
                        yarockcount++;
                        yarocksum = yarocksum + doc.data().sum;
                    });
                });
                if (yarocksum > winnerCount) {
                    winnerCount = yarocksum;
                    winnerName = 'yarock';
                };
                let beentheresum = 0;
                let beentherecount = 0;
                await db.collection("votes").where("vote", "==", "beenthere").get().then((qq) => {
                    qq.forEach((doc) => {
                        beentherecount++;
                        beentheresum = beentheresum + doc.data().sum;
                    });
                });
                if (beentheresum > winnerCount) {
                    winnerCount = beentheresum;
                    winnerName = 'beenthere';
                }
                results['miba'] = {
                    amount: mibacount,
                    count: mibasum
                };
                results['yarock'] = {
                    amount: yarockcount,
                    count: yarocksum
                };
                results['beenthere'] = {
                    amount: beentherecount,
                    count: beentheresum
                };

                // console.log(`beentherecount=${beentherecount}`);
                // console.log(`beentheresum=${beentheresum}`);
                // await db.collection("results").get().then((querySnapshot) => {
                //     querySnapshot.forEach((doc) => {
                //         // doc.data() is never undefined for query doc snapshots
                //         const groupResult = doc.data();
                //         console.log(doc.id, " => ", groupResult);
                //         results[doc.id] = groupResult;
                //         if (groupResult.count > winnerCount) {
                //             winnerCount = groupResult.count;
                //             winnerName = groupResult.name;
                //         }
                //     });
                // });
                console.log(results);
                console.log(winnerName);
                resultsView(results, winnerName.toLowerCase());

            }

            switch (type) {
                default:
                    // loadEl.textContent = 'זה הזמן להשפיע';
                    // loadEl1.textContent = 'אנא הצבע/י לכל אחד מהמיזמים';
                    // const cards = document.querySelector('.cards');
                    // document.getElementById('cards').style.opacity = 0;
                    // cards.innerHTML = getCards();
                    // document.getElementById('cards').style.opacity = 1;
                    break;
            }
        } catch (e) {
            console.error(e);
            loadEl.textContent = 'Error';
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>


</html>